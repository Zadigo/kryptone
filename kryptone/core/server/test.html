<!DOCTYPE html>
<html lang="fr">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
      <title>Twisted</title>

      <!-- Bootstrap -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
      <!-- MD Bootstrap -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.1.0/mdb.min.css">
    </head>

    <body>
        <main>
            <div id="app">
                <card-component />
            </div>
        </main>

        <script id="card-component" type="text/x-template">
            <div class="container">
                <div class="row">
                    <div class="col-8 offset-md-2 my-4 text-center">
                        <div class="card">
                            <div class="card-body">
                                <h2>Twisted</h2>
                                <div v-if="isConnected" class="span p-1 badge text-bg-success mt-4">Connected</div>
                                <div v-else class="span p-3 badge text-bg-danger">Disconnected</div>
                                <button class="btn btn-rounded btn-primary" @click="handleSendData">Send data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </script>

       <!-- Lodash -->
       <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

       <!-- Vuejs -->
       <script src="https://unpkg.com/vue@3"></script>

       <!-- Axios -->
       <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

       <!-- Store -->
       <script src="https://unpkg.com/vuex@4"></script>

       <!-- Router -->
       <script src="https://unpkg.com/vue-router@4"></script>

       <!-- DayJS -->
       <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>

       <script>
            axios.defaults.headers.common['Content-Type'] = 'application/json'
            axios.defaults.headers.common['Accept-Language'] = 'fr,en-US;q=0.9'

            const client = axios.create({
                baseURL: 'http://127.0.0.1:8000',
                timeout: 5000,
                withCredentials: true
            })
       </script>

       <script>
            const { createRouter, createWebHistory } = VueRouter
            const router = createRouter({
                history: createWebHistory(),
                routes: []
            })
       </script>

       <script>
            const { createApp } = Vue

            const app = createApp({
                name: 'App',
                template: '#card-component',
                data () {
                    return {
                        socket: null
                    }
                },
                computed: {
                    isConnected () {
                        return this.socket !== null
                    }
                },
                beforeMount () {    
                    this.createConnection()                    
                },
                methods: {
                    handleSendData () {
                        const data = JSON.stringify({'message': 'Hi!'})
                        console.log(this.socket.readyState)
                        this.socket.send(data)
                        // console.log(data)
                    },
                    createConnection () {
                        const self = this
                        const socket = new WebSocket('ws://localhost:3459')
                        socket.onopen = (e) => {
                            console.log(e)
                        }
                        socket.onmessage = (e) => {
                            console.log(e)
                        }
                        socket.onclose = (e) => {
                            self.socket = null
                        }
                        socket.onerror = (e) => {
                            console.error(e)
                        }
                        this.socket = socket
                        return socket
                    }
                }
            })

            app.use(router)

            app.use((app) => {
                app.config.globalProperties.http = axios
            })

            app.mount('#app')
       </script>
    </body>
</html>
